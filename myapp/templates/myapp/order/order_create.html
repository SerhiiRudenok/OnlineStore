{% extends 'myapp/template.html' %}
{% load static %}

{% block content %}
    <div class="page-container">
        <div class="content-box">
            <h2 class="main-heading">Оформлення замовлення</h2>

            <div class="form-group">
                <h5 class="sub-heading">Ваші контактні дані:</h5>
                <ul class="info-list">
                    <li><strong class="info-label">Ім’я:</strong> {{ request.user.first_name|default:"[Обов’язково заповнити]" }}</li>
                    <li><strong class="info-label">Прізвище:</strong> {{ request.user.last_name|default:"[Обов’язково заповнити]" }}</li>
                    <li><strong class="info-label">Телефон:</strong> {{ request.user.userprofile.phone|default:"[Обов’язково заповнити]" }}</li>
                </ul>
                {% if not request.user.first_name or not request.user.last_name or not request.user.userprofile.phone %}
                    <a href="{% url 'profile_update' %}" class="universal-btn orange-outline-btn cusl1">Редагувати профіль</a>
                {% endif %}
            </div>

            <div class="product-list-container">
                {% for item in items %}
                <div class="order-item card-date">
                    <div class="card-item">
                        <strong>{{ item.name }}</strong><br>
                        <small>{{ item.quantity }} x {{ item.price }} грн</small>
                    </div>
                    <div class="price-r">{{ item.total }} грн</div>
                </div>
                {% endfor %}
            </div><br>

            <div class="text-center">
                <h4 class="cart-total-price">Загальна сума: {{ total_price }} грн</h4>
            </div>

            {% if error_message %}
            <div class="error-message">{{ error_message }}</div>
            {% endif %}
        </div>

        <div class="content-box">
            <form method="get" action="{% url 'order_create' %}" class="form-group">
                <input type="hidden" name="delivery_method" value="{{ selected_delivery_method }}">
                <input type="hidden" name="delivery_address" value="{{ delivery_address }}">
                <div class="form-group">
                    <label for="payment_method">Спосіб оплати:</label>
                    <select name="payment_method" id="payment_method" onchange="this.form.submit()">
                        {% for value, label in payment_choices %}
                            <option value="{{ value }}" {% if value == selected_payment_method %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>

            <form method="post" action="{% url 'order_create' %}" id="order-form">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="submit_order">
                <input type="hidden" name="payment_method" value="{{ selected_payment_method }}">

                <div class="form-group">
                    <label for="delivery_method">Спосіб доставки:</label>
                    <select name="delivery_method" id="delivery_method" required>
                        {% for value, label in delivery_choices %}
                            <option value="{{ value }}" {% if value == selected_delivery_method %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="delivery_address">Адреса доставки:</label>
                    <input type="text" name="delivery_address" id="delivery_address" value="{{ delivery_address }}" required>
                </div>

                {% if selected_payment_method == 'card' %}
                <div class="form-container">
                    <h5 class="sub-heading">Дані картки</h5>
                    <div class="form-group">
                        <label for="card_number">Номер карти:</label>
                        <input type="text" name="card_number" id="card_number" maxlength="16" pattern="\d{16}" required>
                    </div>

                    <div class="form-group">
                        <label>Термін дії:</label>
                        <div class="one-line-form card-date cusl5">
                            <div>
                                <input type="text" name="card_month" id="card_month" maxlength="2" pattern="\d{2}" required>
                            </div>
                            <div style="font-size: 20px;">/</div>
                            <div>
                                <input type="text" name="card_year" id="card_year" maxlength="2" pattern="\d{2}" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="card_cvv">CVV:</label>
                        <input type="password" name="card_cvv" id="card_cvv" maxlength="3" pattern="\d{3}" required>
                    </div>
                </div>
                {% endif %}

                <div class="one-line-buttons">
                    <button type="submit" class="universal-btn orange-filled-btn cusl2">
                        <i class="fas fa-check"></i> Підтвердити замовлення
                    </button>
                    <a href="{% url 'booking_detail' %}" class="universal-btn back-btn cusl2">
                        <i class="fas fa-edit"></i> Змінити замовлення
                    </a>
                </div>
            </form>
        </div>
    </div>
{% endblock %}