{% extends 'myapp/template.html' %}
{% load static %}

{% block title %} Результат пошуку {% endblock %}

{% block content %}
    <div class="page-container">
        <div class="content-b">
            <h4 class="filter-form">
                <span class="search-label">Результати пошуку:</span>
                <span class="search-query" style="color: green;">{{ search_query }}</span>
            </h4>
            <form method="get" class="filter-form">
                <input type="hidden" name="q" value="{{ search_query }}">
                <input type="hidden" name="category" value="{{ selected_category }}">
                <div class="filter-group">
                    <label for="category" class="filter-label">Категорія:</label>
                    <select name="category" id="category" class="filter-select" onchange="this.form.submit()">
                        <option value="">Всі категорії</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if cat.id == selected_category %}selected{% endif %}>
                                {{ cat.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="sort" class="filter-label">Сортування:</label>
                    <select name="sort" id="sort" class="filter-select" onchange="this.form.submit()">
                        <option value="">Без сортування</option>
                        <option value="price_asc" {% if selected_sort == 'price_asc' %}selected{% endif %}>Від дешевих до дорогих</option>
                        <option value="price_desc" {% if selected_sort == 'price_desc' %}selected{% endif %}>Від дорогих до дешевих</option>
                    </select>
                </div>
            </form>
            <br>
            {% if products %}
                <!-- Вивід товарів після пошуку -->
                <div class="products-grid container-fluid">
                    {% for product in products %}
                    <div class="product-card">
                        <a href="{% url 'product_detail' pk=product.id %}" class="product-link">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
                            {% else %}
                            <img src="{% static 'images/no-image.jpg' %}" alt="Фото товару" class="product-image">
                            {% endif %}
                            <div class="product-info">
                                <div class="product-name">{{ product.name }}</div>

                                <div class="product-rating">
                                    {% if product.review_count > 0 %}
                                        <span class="rating-stars">
                                            {% with rounded_rating=product.average_rating|floatformat:0|add:0 %}
                                                {% for _ in ""|ljust:rounded_rating %}⭐{% endfor %}
                                            {% endwith %}
                                        </span>
                                        <span class="rating-text"><strong>{{ product.average_rating|floatformat:1 }}</strong>/5</span>
                                        <span class="review-count-link">{{ product.review_count_text }}</span>
                                    {% else %}
                                        <span class="no-reviews-text">Відгуків поки немає</span>
                                    {% endif %}
                                </div>

                                <div class="product-price" style="padding-top: 20px;">{{ product.price }} грн</div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="empty-message text-center">Немає товарів за обраними параметрами.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}